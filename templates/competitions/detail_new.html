{% extends 'layout.html' %}

{% block content %}
<div class="container">
    <!-- Top Competition Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">{{ competition.title }}</h1>
                    <div class="d-flex align-items-center mt-2">
                        <span class="badge bg-{{ 'success' if competition.status.value == 'ACTIVE' else ('warning' if competition.status.value == 'UPCOMING' else 'secondary') }} me-2">
                            {{ competition.status.value.capitalize() }}
                        </span>
                        {% if competition.is_public %}
                        <span class="badge bg-info me-2">Public</span>
                        {% else %}
                        <span class="badge bg-secondary me-2">Private</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    {% if is_host %}
                    <a href="{{ url_for('host.manage_competition', competition_id=competition.id) }}" class="btn btn-primary me-2">
                        <i class="fas fa-cog me-1"></i> Manage
                    </a>
                    {% endif %}
                    <a href="{{ url_for('competitions.list_competitions') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i> Back to Competitions
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Competition Banner Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark competition-banner">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <!-- Competition Details -->
                        <div class="col-md-8">
                            <!-- Competition Description -->
                            <p class="lead">{{ competition.description }}</p>
                            
                            {% if competition.status.value == 'ACTIVE' and is_registered %}
                            <div class="alert alert-success mt-3">
                                <i class="fas fa-gamepad me-2"></i> This competition is active! Go to the <a href="{{ url_for('challenges.list_challenges') }}" class="alert-link">Challenges</a> page to start solving.
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Competition Stats -->
                        <div class="col-md-4">
                            <div class="card h-100 competition-stats">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="far fa-calendar-alt me-1"></i> Start:</span>
                                        <span>{{ competition.start_time.strftime('%Y-%m-%d %H:%M') }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="far fa-calendar-check me-1"></i> End:</span>
                                        <span>{{ competition.end_time.strftime('%Y-%m-%d %H:%M') }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="fas fa-users me-1"></i> Participants:</span>
                                        <span>{{ competition.participants|length }}{% if competition.max_participants %}/{{ competition.max_participants }}{% endif %}</span>
                                    </div>
                                    
                                    {% if competition.status.value == 'ACTIVE' %}
                                    <div class="alert alert-info mt-3 mb-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-clock me-1"></i> Time left:</span>
                                            <span class="competition-countdown fw-bold" data-end-time="{{ competition.end_time.isoformat() }}">
                                                Loading...
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Host Recognition Block -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-info">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <!-- Host Image -->
                        <div class="col-md-3 text-center">
                            <div class="host-image-container mb-3 mb-md-0">
                                {% if competition.host.avatar %}
                                <img src="{{ competition.host.avatar }}" alt="{{ competition.host.username }}" class="img-fluid rounded-circle host-image">
                                {% else %}
                                <div class="placeholder-host-image rounded-circle d-flex align-items-center justify-content-center bg-secondary">
                                    <i class="fas fa-user-circle fa-4x text-light"></i>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Host Info -->
                        <div class="col-md-9">
                            <div class="host-info">
                                <h4 class="mb-2">Hosted By: <span class="text-info">{{ competition.host.username }}</span></h4>
                                {% if competition.host.bio %}
                                <p>{{ competition.host.bio|truncate(200) }}</p>
                                {% else %}
                                <p class="text-muted">This host hasn't added a bio yet.</p>
                                {% endif %}
                                
                                <!-- Co-hosts section (if any) -->
                                {% if competition.additional_hosts|length > 0 %}
                                <div class="co-hosts mt-3">
                                    <h5 class="mb-2">Co-Hosts:</h5>
                                    <div class="d-flex flex-wrap">
                                        {% for host_relation in competition.additional_hosts %}
                                        <div class="co-host-badge me-2 mb-2 d-flex align-items-center bg-dark p-2 rounded">
                                            {% if host_relation.host.avatar %}
                                            <img src="{{ host_relation.host.avatar }}" alt="{{ host_relation.host.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                            {% else %}
                                            <i class="fas fa-user-circle fa-2x me-2 text-secondary"></i>
                                            {% endif %}
                                            <span>{{ host_relation.host.username }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark">
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <h4 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Registration</h4>
                            <p>Join this competition to test your skills and compete with others. Registration is {% if competition.max_participants %}limited to {{ competition.max_participants }} participants{% else %}open to everyone{% endif %}.</p>
                        </div>
                        <div class="col-md-4 d-flex align-items-center justify-content-center">
                            {% if current_user.is_authenticated %}
                                {% if not is_registered and competition.status.value != 'ENDED' %}
                                    {% if competition.max_participants and competition.participants|length >= competition.max_participants %}
                                    <div class="alert alert-warning w-100">
                                        <i class="fas fa-exclamation-triangle me-2"></i> This competition has reached its maximum number of participants.
                                    </div>
                                    {% else %}
                                    <form action="{{ url_for('competitions.register', competition_id=competition.id) }}" method="POST" class="w-100">
                                        {{ form.hidden_tag() }}
                                        <button type="submit" class="btn btn-success w-100 py-3">
                                            <i class="fas fa-user-plus me-1"></i> Register for Competition
                                        </button>
                                    </form>
                                    {% endif %}
                                {% elif is_registered and competition.status.value == 'UPCOMING' %}
                                <form action="{{ url_for('competitions.unregister', competition_id=competition.id) }}" method="POST" class="w-100">
                                    <button type="submit" class="btn btn-outline-danger w-100 py-2">
                                        <i class="fas fa-times-circle me-1"></i> Unregister
                                    </button>
                                </form>
                                {% elif is_registered %}
                                <div class="alert alert-success w-100">
                                    <i class="fas fa-check-circle me-2"></i> You are registered for this competition!
                                </div>
                                {% endif %}
                            {% else %}
                            <div class="alert alert-info w-100">
                                <i class="fas fa-info-circle me-2"></i> <a href="{{ url_for('auth.login') }}">Login</a> to register for this competition.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Promotional Content Section -->
    {% if competition.status.value != 'ENDED' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-info position-relative overflow-hidden">
                <div class="promotional-badge position-absolute top-0 end-0 bg-info text-dark py-1 px-3 m-2 rounded">
                    <i class="fas fa-star me-1"></i> Featured
                </div>
                <div class="card-body p-4">
                    <h4 class="mb-3"><i class="fas fa-bullhorn me-2"></i>Competition Highlights</h4>
                    <div class="row">
                        <!-- Promotional Items (will be replaced with dynamic content) -->
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="promo-item h-100 bg-dark p-3 rounded text-center">
                                <div class="promo-image-placeholder bg-secondary rounded mb-3" style="height: 150px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-trophy fa-3x text-warning"></i>
                                </div>
                                <h5>Amazing Prizes</h5>
                                <p class="mb-0">Top performers will be rewarded with special recognition and badges.</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="promo-item h-100 bg-dark p-3 rounded text-center">
                                <div class="promo-image-placeholder bg-secondary rounded mb-3" style="height: 150px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-puzzle-piece fa-3x text-primary"></i>
                                </div>
                                <h5>Unique Challenges</h5>
                                <p class="mb-0">Carefully crafted challenges designed to test various security skills.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="promo-item h-100 bg-dark p-3 rounded text-center">
                                <div class="promo-image-placeholder bg-secondary rounded mb-3" style="height: 150px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-users fa-3x text-success"></i>
                                </div>
                                <h5>Community</h5>
                                <p class="mb-0">Connect with like-minded security enthusiasts and learn together.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Tabs for Competition Details -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs mb-4" id="competitionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="leaderboard-tab" data-bs-toggle="tab" data-bs-target="#leaderboard-content" type="button" role="tab" aria-controls="leaderboard-content" aria-selected="true">
                        <i class="fas fa-trophy me-1"></i> Leaderboard
                    </button>
                </li>
                {% if is_registered or is_host or current_user.is_admin() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="challenges-tab" data-bs-toggle="tab" data-bs-target="#challenges-content" type="button" role="tab" aria-controls="challenges-content" aria-selected="false">
                        <i class="fas fa-puzzle-piece me-1"></i> Challenges
                    </button>
                </li>
                {% endif %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules-content" type="button" role="tab" aria-controls="rules-content" aria-selected="false">
                        <i class="fas fa-book me-1"></i> Rules
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="competitionTabsContent">
                <!-- Leaderboard Tab -->
                <div class="tab-pane fade show active" id="leaderboard-content" role="tabpanel" aria-labelledby="leaderboard-tab">
                    <h4 class="mb-3">Competition Leaderboard</h4>
                    
                    {% if leaderboard and (competition.show_leaderboard or is_host or current_user.is_admin()) %}
                        <div class="table-responsive">
                            <table class="table table-dark table-hover leaderboard-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Player</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in leaderboard %}
                                    <tr{% if current_user.is_authenticated and entry.username == current_user.username %} class="table-primary"{% endif %}>
                                        <td>{{ entry.rank }}</td>
                                        <td>{{ entry.username }}</td>
                                        <td>{{ entry.score }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    
                        <div class="text-center mt-4">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h5>Leaderboard Visualization</h5>
                                    <canvas id="leaderboardChart" height="300" data-leaderboard='{{ leaderboard|tojson }}'></canvas>
                                </div>
                            </div>
                        </div>
                    
                    {% elif not competition.show_leaderboard and not is_host and not current_user.is_admin() %}
                        <div class="alert alert-info">
                            <i class="fas fa-eye-slash me-2"></i>The leaderboard for this competition is currently hidden.
                        </div>
                    {% endif %}
                </div>
            
                <!-- Challenges Tab -->
                {% if is_registered or is_host or current_user.is_admin() %}
                <div class="tab-pane fade" id="challenges-content" role="tabpanel" aria-labelledby="challenges-tab">
                    <h4 class="mb-3">Competition Challenges</h4>
                    
                    {% if competition.status.value == 'UPCOMING' %}
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>Challenges will be available once the competition starts.
                    </div>
                    {% elif competition.status.value == 'ENDED' %}
                    <div class="alert alert-secondary">
                        <i class="fas fa-flag-checkered me-2"></i>This competition has ended. Challenges are no longer available for solving.
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>Visit the <a href="{{ url_for('challenges.list_challenges') }}" class="alert-link">Challenges</a> page to view and solve available challenges.
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Rules Tab -->
                <div class="tab-pane fade" id="rules-content" role="tabpanel" aria-labelledby="rules-tab">
                    <h4 class="mb-3">Competition Rules</h4>
                    
                    <div class="card bg-dark">
                        <div class="card-body">
                            <ol class="mb-0">
                                <li class="mb-2">All participants must adhere to the platform's code of conduct.</li>
                                <li class="mb-2">Do not share flags or solutions with other participants.</li>
                                <li class="mb-2">Do not attempt to attack the platform infrastructure.</li>
                                <li class="mb-2">Focus your efforts on finding the intended solutions, not on exploiting the platform.</li>
                                <li class="mb-2">The competition will run from {{ competition.start_time.strftime('%Y-%m-%d %H:%M') }} to {{ competition.end_time.strftime('%Y-%m-%d %H:%M') }}.</li>
                                <li class="mb-2">Challenges may be released progressively during the competition.</li>
                                <li class="mb-2">Points are awarded based on challenge difficulty.</li>
                                <li class="mb-2">The leaderboard is updated in real-time as participants solve challenges.</li>
                                <li class="mb-2">In case of a tie, the participant who reached the score first wins.</li>
                                <li class="mb-2">The organizers' decisions are final in case of disputes.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS for new competition page elements -->
<style>
.placeholder-host-image {
    width: 150px;
    height: 150px;
    margin: 0 auto;
}

.host-image {
    width: 150px;
    height: 150px;
    object-fit: cover;
}

.competition-banner {
    border-left: 4px solid var(--bs-info);
}

.competition-stats {
    background-color: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.promo-item {
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.promo-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
{% endblock %}