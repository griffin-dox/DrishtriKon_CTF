{% extends "layout.html" %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.perf-card {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #00ff00;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #00ff00;
}

.metric-label {
    color: #888;
    font-size: 0.9rem;
}

.status-good { color: #00ff00; }
.status-warning { color: #ffa500; }
.status-bad { color: #ff4444; }

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-tachometer-alt me-2"></i>Performance Monitor</h2>
            <p class="text-muted">Real-time performance metrics for the CTF platform</p>
        </div>
    </div>

    <!-- System Overview -->
    <div class="row">
        <div class="col-md-3">
            <div class="perf-card">
                <div class="metric-label">CPU Usage</div>
                <div class="metric-value" id="cpu-usage">--</div>
                <div class="progress mt-2">
                    <div class="progress-bar bg-success" id="cpu-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="perf-card">
                <div class="metric-label">Memory Usage</div>
                <div class="metric-value" id="memory-usage">--</div>
                <div class="progress mt-2">
                    <div class="progress-bar bg-info" id="memory-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="perf-card">
                <div class="metric-label">Database Pool</div>
                <div class="metric-value" id="db-pool">--</div>
                <div class="small text-muted" id="db-pool-details">--</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="perf-card">
                <div class="metric-label">Cache Status</div>
                <div class="metric-value" id="cache-status">--</div>
                <div class="small text-muted" id="cache-type">--</div>
            </div>
        </div>
    </div>

    <!-- Response Time Chart -->
    <div class="row">
        <div class="col-12">
            <div class="perf-card">
                <h4>Response Times</h4>
                <div class="chart-container">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <div class="perf-card">
                <h4>Cache Management</h4>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-warning" onclick="clearCache()">
                        <i class="fas fa-trash"></i> Clear Cache
                    </button>
                    <button type="button" class="btn btn-success" onclick="warmCache()">
                        <i class="fas fa-fire"></i> Warm Cache
                    </button>
                    <button type="button" class="btn btn-info" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Refresh Data
                    </button>
                </div>
                <div id="action-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Detailed Stats -->
    <div class="row">
        <div class="col-md-6">
            <div class="perf-card">
                <h4>System Details</h4>
                <div id="system-details">Loading...</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="perf-card">
                <h4>Database Details</h4>
                <div id="database-details">Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let responseTimeChart;
let updateInterval;

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    refreshData();
    
    // Auto-refresh every 30 seconds
    updateInterval = setInterval(refreshData, 30000);
});

function initializeChart() {
    const ctx = document.getElementById('responseTimeChart').getContext('2d');
    responseTimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Database Query (ms)',
                    data: [],
                    borderColor: '#00ff00',
                    backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Cache Operation (ms)',
                    data: [],
                    borderColor: '#0099ff',
                    backgroundColor: 'rgba(0, 153, 255, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Template Render (ms)',
                    data: [],
                    borderColor: '#ff9900',
                    backgroundColor: 'rgba(255, 153, 0, 0.1)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Response Time Trends',
                    color: '#fff'
                },
                legend: {
                    labels: {
                        color: '#fff'
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#fff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: '#fff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

async function refreshData() {
    try {
        // Fetch all data in parallel
        const [systemStats, dbStats, cacheStats, responseTest] = await Promise.all([
            fetch('/admin/performance/api/system-stats').then(r => r.json()),
            fetch('/admin/performance/api/database-stats').then(r => r.json()),
            fetch('/admin/performance/api/cache-stats').then(r => r.json()),
            fetch('/admin/performance/api/response-time-test').then(r => r.json())
        ]);

        updateSystemMetrics(systemStats);
        updateDatabaseMetrics(dbStats);
        updateCacheMetrics(cacheStats);
        updateResponseTimeChart(responseTest);
        
    } catch (error) {
        console.error('Error refreshing data:', error);
        showStatus('Error refreshing data: ' + error.message, 'danger');
    }
}

function updateSystemMetrics(data) {
    if (data.error) return;
    
    const cpu = data.system.cpu_percent;
    const memory = data.system.memory_percent;
    
    document.getElementById('cpu-usage').textContent = cpu.toFixed(1) + '%';
    document.getElementById('cpu-progress').style.width = cpu + '%';
    document.getElementById('cpu-progress').className = `progress-bar ${cpu > 80 ? 'bg-danger' : cpu > 60 ? 'bg-warning' : 'bg-success'}`;
    
    document.getElementById('memory-usage').textContent = memory.toFixed(1) + '%';
    document.getElementById('memory-progress').style.width = memory + '%';
    document.getElementById('memory-progress').className = `progress-bar ${memory > 80 ? 'bg-danger' : memory > 60 ? 'bg-warning' : 'bg-info'}`;
    
    // Update detailed stats
    document.getElementById('system-details').innerHTML = `
        <small>
            Process Memory: ${(data.process.memory_rss / 1024 / 1024).toFixed(1)} MB<br>
            Process CPU: ${data.process.cpu_percent.toFixed(1)}%<br>
            Threads: ${data.process.num_threads}
        </small>
    `;
}

function updateDatabaseMetrics(data) {
    if (data.error) return;
    
    const pool = data.connection_pool;
    document.getElementById('db-pool').textContent = `${pool.checked_out}/${pool.size}`;
    document.getElementById('db-pool-details').textContent = `Overflow: ${pool.overflow}`;
    
    document.getElementById('database-details').innerHTML = `
        <small>
            Pool Size: ${pool.size}<br>
            Checked Out: ${pool.checked_out}<br>
            Checked In: ${pool.checked_in}<br>
            Overflow: ${pool.overflow}<br>
            Invalid: ${pool.invalid}
        </small>
    `;
}

function updateCacheMetrics(data) {
    if (data.error) return;
    
    const status = data.cache_health.status;
    document.getElementById('cache-status').textContent = status;
    document.getElementById('cache-status').className = `metric-value ${status === 'healthy' ? 'status-good' : 'status-bad'}`;
    document.getElementById('cache-type').textContent = data.cache_health.type || data.cache_type;
}

function updateResponseTimeChart(data) {
    if (data.error) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const times = data.response_times_ms;
    
    // Add new data point
    if (responseTimeChart.data.labels.length >= 20) {
        responseTimeChart.data.labels.shift();
        responseTimeChart.data.datasets.forEach(dataset => dataset.data.shift());
    }
    
    responseTimeChart.data.labels.push(timestamp);
    responseTimeChart.data.datasets[0].data.push(times.database_query || 0);
    responseTimeChart.data.datasets[1].data.push(times.cache_operation || 0);
    responseTimeChart.data.datasets[2].data.push(times.template_render || 0);
    
    responseTimeChart.update('none');
}

async function clearCache() {
    try {
        const response = await fetch('/admin/performance/api/clear-cache', { method: 'POST' });
        const data = await response.json();
        showStatus(data.message || 'Cache cleared', 'success');
    } catch (error) {
        showStatus('Error clearing cache: ' + error.message, 'danger');
    }
}

async function warmCache() {
    try {
        const response = await fetch('/admin/performance/api/warm-cache', { method: 'POST' });
        const data = await response.json();
        showStatus(data.message || 'Cache warmed up', 'success');
    } catch (error) {
        showStatus('Error warming cache: ' + error.message, 'danger');
    }
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('action-status');
    statusDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}
